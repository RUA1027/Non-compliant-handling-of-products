# 生产线违规取放检测系统 (Production Line Violation Detection System)

## 1. 项目背景
在工业 PCB 生产线上，特定工序严禁人工直接接触电路板以防静电或污染。本系统基于计算机视觉技术，实时监控生产线区域。当检测到人手（包括裸手和戴手套的情况）进入监控区域并进行取放操作时，系统将立即触发多级报警，并自动记录违规证据。

## 2. 核心功能
- **多模态手部检测**：融合了 MediaPipe 关键点检测、YCrCb 肤色掩膜和帧差法运动检测，有效应对裸手、手套、复杂光照等多种工况。
- **智能报警逻辑**：采用非对称状态过滤算法，实现“快速触发、即时撤销”，减少误报并提高响应速度。
- **多级预警机制**：
  - **正常 (Normal)**：绿色状态，系统持续监控。
  - **警告 (Warning)**：黄色状态，检测到疑似手部侵入。
  - **危险 (Danger)**：红色状态，确认违规操作，触发声音报警并截图。
- **可视化监控界面**：基于 Tkinter 开发的 GUI，支持实时视频流显示、示例视频一键测试、报警日志滚动查看。
- **自动化证据留存**：违规瞬间自动保存高清截图，并生成包含时间戳、置信度和相对路径的 CSV 事件日志。

## 3. 技术实现方案
### 3.1 检测算法
1.  **MediaPipe Hands**：提供高精度的 21 个手部关键点检测，作为主要识别手段。
2.  **肤色检测 (YCrCb)**：针对裸手操作，利用 YCrCb 色彩空间对肤色进行建模，增强在复杂背景下的鲁棒性。
3.  **运动几何融合**：针对**戴手套**的情况，系统通过帧差法提取运动轮廓，并结合几何特征（长宽比、面积）进行二次校验，弥补了深度学习模型对非标准手部特征识别的不足。

### 3.2 状态管理
系统引入了**连续帧计数器**：
- **触发阈值**：连续检测到手部 8 帧触发报警。
- **恢复逻辑**：一旦手部离开，计数器立即清零（2 帧内恢复），确保报警状态不会在手移开后“滞留”。

## 4. 项目结构
```text
.
├── main.py              # 命令行启动入口 & 批量测试逻辑
├── gui.py               # 图形界面启动入口 (推荐)
├── hand_detector.py     # 核心算法：多模态手部检测器
├── alarm_system.py      # 报警逻辑、声音触发与日志记录
├── video_processor.py   # 视频流处理、OpenCV/PIL 混合渲染
├── config.py            # 全局参数配置 (阈值、路径、颜色)
├── requirements.txt     # 环境依赖清单
├── 视频素材/            # 测试视频 (正常/异常分类)
├── logs/                # 自动生成的 CSV 事件日志
└── screenshots/         # 自动生成的违规截图
```

## 5. 环境配置与运行

### 5.1 依赖安装
本项目对库版本有严格要求（特别是解决 MediaPipe 与 NumPy 2.0+ 的冲突）：
```bash
pip install -r requirements.txt
```
*主要依赖：OpenCV 4.8+, MediaPipe 0.10.14, NumPy 1.26.4, Pillow 10.0+*

### 5.2 运行方式
**方式 A：图形界面模式 (推荐)**
```bash
python gui.py
```
- 点击“打开摄像头”进行实时监控。
- 在下拉框选择“示例视频”并点击“播放示例”进行效果演示。

**方式 B：命令行测试模式**
```bash
# 自动测试“视频素材”目录下的所有视频并输出统计结果
python main.py --test

# 处理指定视频文件
python main.py -v 视频素材/异常/异常3.mp4
```

## 6. 常见问题 (Troubleshooting)
- **声音不响**：声音报警基于 Windows 的 `winsound` 库。若在非 Windows 系统运行，系统将回退至控制台铃声。
- **检测不到戴手套的手**：请确保 `config.py` 中的 `HAND_DETECTION_CONFIDENCE` 设置在 0.4 左右，并开启了运动检测辅助。
- **路径报错**：系统已实现全路径自动化管理，请确保在项目根目录下运行程序。

---
*本系统为机器视觉课程大作业成果，旨在解决工业场景下的违规操作监控问题。*


