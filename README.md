# 生产线违规取放检测系统 (Production Line Violation Detection System)

## 1. 项目背景
在工业 PCB 生产线上，特定工序严禁人工直接接触电路板以防静电或污染。本系统基于计算机视觉技术，实时监控生产线区域。当检测到人手（包括裸手和戴手套的情况）进入监控区域并进行取放操作时，系统将立即触发多级报警，并自动记录违规证据。

## 2. 核心功能
- **多模态融合检测引擎**：创新性地融合了深度学习 (MediaPipe Hands)、传统色彩模型 (YCrCb 肤色分割) 和运动分析 (帧差法)，实现了对裸手、工业手套及复杂光照环境的全场景覆盖。
- **智能时域滤波算法**：采用非对称状态过滤策略（开启需多帧确认防抖，关闭需即时响应灵敏），有效解决了视频流中的检测闪烁问题。
- **工业级 ROI 优化**：支持自定义感兴趣区域 (Region of Interest)，自动排除产线边缘机械臂、背景行人等无关干扰，显著提升检测精度与处理帧率。
- **周期性干扰过滤**：内置运动轨迹分析算法，能够自动识别并屏蔽齿轮、传送带等周期性运动物体的干扰。
- **多级预警与证据留存**：
  - **正常 (Normal)**：绿色状态，系统静默监控。
  - **警告 (Warning)**：黄色状态，检测到疑似侵入，界面边缘预警。
  - **危险 (Danger)**：红色状态，确认违规，触发 **1000Hz 蜂鸣报警**、全屏闪烁特效，并自动保存**高清违规截图**与 **CSV 结构化日志**。

## 3. 技术实现方案
### 3.1 检测算法深度解析
1.  **MediaPipe Hands (深度学习层)**：作为核心检测器，通过 21 个手部关键点回归，提供极高的语义识别准确率。
2.  **YCrCb 肤色模型 (传统视觉层)**：相比 RGB 空间，YCrCb 实现了亮度 (Y) 与色度 (Cr, Cb) 的解耦。系统通过对 Cr/Cb 通道的阈值分割，在产线光照剧烈变化时仍能保持稳定的肤色提取能力。
3.  **帧差法运动补偿 (动态分析层)**：针对工人**戴手套**导致深度学习模型失效的痛点，系统通过计算帧间像素差异提取运动目标，并结合几何特征（面积、长宽比）进行二次校验补报。
4.  **形态学优化**：利用开运算 (Opening) 去除孤立噪点，闭运算 (Closing) 填补手部空洞，确保检测轮廓的完整性。

### 3.2 系统架构设计
- **多线程并发模型**：基于生产者-消费者模式，将视频采集/算法推理（后台线程）与 UI 渲染（主线程）分离，确保在 1080P 高清输入下界面依然响应流畅。
- **观察者模式 (Callback)**：报警系统与 GUI 界面通过回调机制解耦，算法层只负责逻辑判定，UI 层负责视觉呈现，提升了代码的可维护性。
- **跨平台中文渲染**：针对 OpenCV 原生不支持中文的问题，采用 PIL (Pillow) 库进行图像格式桥接，实现了美观的中文字符叠加。

## 4. 项目结构
```text
.
├── main.py              # 命令行启动入口 & 批量测试逻辑
├── gui.py               # 图形界面启动入口 (推荐)
├── hand_detector.py     # 核心算法：多模态手部检测器
├── alarm_system.py      # 报警逻辑、声音触发与日志记录
├── video_processor.py   # 视频流处理、OpenCV/PIL 混合渲染
├── config.py            # 全局参数配置 (阈值、路径、颜色)
├── requirements.txt     # 环境依赖清单
├── 视频素材/            # 测试视频 (正常/异常分类)
├── logs/                # 自动生成的 CSV 事件日志
└── screenshots/         # 自动生成的违规截图
```

## 5. 环境配置与运行

### 5.1 依赖安装
本项目对库版本有严格要求（特别是解决 MediaPipe 与 NumPy 2.0+ 的冲突）：
```bash
pip install -r requirements.txt
```
*主要依赖：OpenCV 4.8+, MediaPipe 0.10.14, NumPy 1.26.4, Pillow 10.0+*

### 5.2 运行方式
**方式 A：图形界面模式 (推荐)**
```bash
python gui.py
```
- 点击“打开摄像头”进行实时监控。
- 在下拉框选择“示例视频”并点击“播放示例”进行效果演示。

**方式 B：命令行测试模式**
```bash
# 自动测试“视频素材”目录下的所有视频并输出统计结果
python main.py --test

# 处理指定视频文件
python main.py -v 视频素材/异常/异常3.mp4
```

## 6. 常见问题 (Troubleshooting)
- **声音不响**：声音报警基于 Windows 的 `winsound` 库。若在非 Windows 系统运行，系统将回退至控制台铃声。
- **检测不到戴手套的手**：请确保 `config.py` 中的 `HAND_DETECTION_CONFIDENCE` 设置在 0.4 左右，并开启了运动检测辅助。
- **路径报错**：系统已实现全路径自动化管理，请确保在项目根目录下运行程序。

---
*本系统为机器视觉课程大作业成果，旨在解决工业场景下的违规操作监控问题。*


